<?php

/**
 * Run test cases for the endpoint with no authentication turned on.
 *
 */
class ServicesResourceWebformTests extends ServicesWebTestCase {

  // Class variables
  protected $privilegedUser = NULL ;
  // Endpoint details.
  protected $endpoint = NULL;

  /**
   * Implementation of setUp().
   */
  public function setUp() {
    parent::setUp(
      'webform',
      'webform_service',
      'uuid'
    );

    $edit = $this->populateEndpointFAPI() ;
    $this->endpoint = new stdClass;
    $this->endpoint->disabled = FALSE; /* Edit this to true to make a default endpoint disabled initially */
    $this->endpoint->api_version = 3;
    $this->endpoint->name = $edit['name'];
    $this->endpoint->server = $edit['server'];
    $this->endpoint->path = $edit['path'];
    $this->endpoint->authentication = array(
      'services' => 'services',
    );
    $this->endpoint->server_settings = array(
      'formatters' => array(
        'json' => TRUE,
        'bencode' => TRUE,
        'rss' => TRUE,
        'plist' => TRUE,
        'xmlplist' => TRUE,
        'php' => TRUE,
        'yaml' => TRUE,
        'jsonp' => FALSE,
        'xml' => FALSE,
      ),
      'parsers' => array(
        'application/x-yaml' => TRUE,
        'application/json' => TRUE,
        'application/vnd.php.serialized' => TRUE,
        'application/plist' => TRUE,
        'application/plist+xml' => TRUE,
        'application/x-www-form-urlencoded' => TRUE,
        'multipart/form-data' => TRUE,
      ),
    );
    $this->endpoint->resources = array(
      'submission' => array(
        'operations' => array(
          'create' => array(
            'enabled' => 1,
          ),
          'update' => array(
            'enabled' => 1,
          ),
          'retrieve' => array(
            'enabled' => 1,
          ),
          'delete' => array(
            'enabled' => 1,
          ),
        ),
      ),
    );

    // Get all the webform types.
    $types = webform_variable_get('webform_node_types');

    // Iterate through the webform types.
    foreach ($types as $type) {
      $this->endpoint->resources[$type] = array(
        'operations' => array(
          'create' => array(
            'enabled' => 1,
          ),
          'retrieve' => array(
            'enabled' => 1,
          ),
          'update' => array(
            'enabled' => 1,
          ),
          'delete' => array(
            'enabled' => 1,
          ),
          'index' => array(
            'enabled' => 1,
          ),
        ),
        'relationships' => array(
          'submissions' => array(
            'enabled' => 1,
          ),
        ),
      );
    }

    $this->endpoint->debug = 1;
    $this->endpoint->export_type = FALSE;
    services_endpoint_save($this->endpoint);
    $endpoint = services_endpoint_load($this->endpoint->name);
    $this->assertTrue($endpoint->name == $edit['name'], t('Endpoint successfully created'));
  }

  /**
   * Implementation of getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => t('Webform & Submissions'),
      'description' => t('Test the webform resource and submission methods and actions.'),
      'group' => t('Services'),
    );
  }

  /**
   * testing node_resource Index
   */
  public function testNewEndpointWebformIndex() {
    $types = webform_variable_get('webform_node_types');

    // Create and log in our privileged user.
    $this->privilegedUser = $this->drupalCreateUser(array(
      'administer services',
      'perform unlimited index queries',
    ));
    $this->drupalLogin($this->privilegedUser);

    // Create a set of nodes. The node resource returns 20 returns at a time,
    // so we create two pages and a half worth.
    $nodes = array();
    $count = 50;
    for ($i = 0; $i < $count; $i++) {
      $node = $this->drupalCreateNode(array('type' => $types[0]));
      $nodes[$node->uuid] = $node;
    }

    // Get the content.
    $page_count = ceil(count($nodes) / 20);
    $retrieved_nodes = array();
    for ($page = 0; $page < $page_count; $page++) {
      $responseArray = $this->servicesGet($this->endpoint->path . '/' . $types[0], array('page' => $page));
      $this->assertTrue(count($responseArray['body']) <= 20, t('Correct number of items returned'));

      // Store the returned node IDs.
      foreach ($responseArray['body'] as $node) {
        if (isset($retrieved_nodes[$node->uuid])) {
          $this->fail(t('Duplicate node @uuid returned.', array('@uuid' => $node->uuid)));
        }
        $retrieved_nodes[$node->uuid] = TRUE;

        $this->assertTrue($nodes[$node->uuid]->title == $node->title, t('Successfully received Node info'), 'NodeResource: Index');
      }
    }

    // We should have got all the nodes.
    $expected_nids = array_keys($nodes);
    sort($expected_nids);
    $retrieved_nids = array_keys($retrieved_nodes);
    sort($retrieved_nids);
    $this->assertEqual($expected_nids, $retrieved_nids, t('Retrieved all nodes'));

    // The n+1 page should be empty.
    $responseArray = $this->servicesGet($this->endpoint->path . '/' . $types[0], array('page' => $page_count + 1));
    $this->assertEqual(count($responseArray['body']), 0, t('The n+1 page is empty'));

    // Adjust the pager size.
    $responseArray = $this->servicesGet($this->endpoint->path . '/' . $types[0], array('pagesize' => 40));
    $this->assertTrue(count($responseArray['body']) == 40, t('Correct number of items returned'));

    // Swap to user that can only use the default pager size.
    $this->lessPrivilegedUser = $this->drupalCreateUser(array(
      'administer services',
    ));
    $this->drupalLogin($this->lessPrivilegedUser);
    $responseArray = $this->servicesGet($this->endpoint->path . '/' . $types[0], array('pagesize' => 40));
    $this->assertTrue(count($responseArray['body']) == 20, t('Correct number of items returned'));
  }

  /**
   * testing node_resource Get
   */
  public function testNewEndpointWebformGet() {
    $types = webform_variable_get('webform_node_types');

    // Create and log in our privileged user.
    $this->privilegedUser = $this->drupalCreateUser(array(
      'administer services',
    ));
    $this->drupalLogin($this->privilegedUser);
    $node = $this->drupalCreateNode(array('type' => $types[0]));

    // Get the endpoint.
    $endpoint = $this->endpoint->path . '/' . $types[0];

    $responseArray = $this->servicesGet($endpoint . '/' . $node->uuid);
    $this->assertTrue($node->title == $responseArray['body']->title, t('Successfully received Webform'), 'Webform: Retrieve');
    //Verify node not found.
    unset($node);
    $responseArray = $this->servicesGet($endpoint . '/1234');
    $this->assertTrue($responseArray['code'] == '404', t('Successfully was rejected to non existent webform'), 'Webform: Retrieve');
  }

  /**
   * Testing webform Create.
   */
  public function testEndpointWebformCreate() {
    $types = webform_variable_get('webform_node_types');

    // Create and log in our privileged user.
    $this->privilegedUser = $this->drupalCreateUser(array(
      'administer services',
      'bypass node access',
    ));
    $this->drupalLogin($this->privilegedUser);

    // Define our webform components.
    $components = array(
      1 => array(
        'id' => 'first_name',
        'type' => 'textfield',
        'name' => 'First Name',
      ),
      2 => array(
        'id' => 'last_name',
        'type' => 'textfield',
        'name' => 'Last Name',
      ),
      3 => array(
        'id' => 'email',
        'type' => 'email',
        'name' => 'Email'
      )
    );

    $node = array(
      'title' => 'testing',
      'body' => array(LANGUAGE_NONE => array(array('value' => $this->randomString()))),
      'name' => $this->privilegedUser->name,
      'language' => LANGUAGE_NONE,
      'webform' => array(
        'components' => $components
      )
    );

    // Get the endpoint.
    $endpoint = $this->endpoint->path . '/' . $types[0];

    $responseArray = $this->servicesPost($endpoint, array('webform' => $node));
    $nodeResourceCreateReturn = $responseArray['body'];

    $this->assertTrue(isset($nodeResourceCreateReturn->uuid), t('Webform was successfully created'), 'Webform: Create');
    $webform = webform_service_resource_load($nodeResourceCreateReturn->uuid);
    $this->assertTrue($webform->title = $node['title'], t('Title was the same'), 'Webform: Create');
    $this->assertTrue($webform->body = $node['body'], t('Body was the same'), 'Webform: Create');

    // Now make sure the webform was created.
    $this->assertTrue(!empty($webform->webform), t('Webform created.'), 'Webform: Create');
    $this->assertTrue(!empty($webform->webform['components']), t('Components created.'), 'Webform: Create');
    $this->assertTrue(count($webform->webform['components']) === 3, t('Number of components created.'), 'Webform: Create');
    foreach ($components as $cid => $component) {
      $this->assertTrue(!empty($webform->webform['components'][$cid]), 'Component was created', 'Webform: Create');
      $this->assertTrue($webform->webform['components'][$cid]['form_key'] == $component['form_key'], t('Components match.'), 'Webform: Create');
    }

  }
}
